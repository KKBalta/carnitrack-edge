# ═══════════════════════════════════════════════════════════════════════════════
# CarniTrack Edge Service - Docker Compose
# ═══════════════════════════════════════════════════════════════════════════════
# 
# Usage:
#   Development:  docker compose up
#   Production:   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   Logs:         docker compose logs -f carnitrack-edge
#   Stop:         docker compose down
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  carnitrack-edge:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: carnitrack-edge
    restart: unless-stopped
    
    # ─────────────────────────────────────────────────────────────────────────────
    # Port Mapping
    # ─────────────────────────────────────────────────────────────────────────────
    ports:
      # Admin Dashboard (HTTP)
      - "${HTTP_PORT:-3000}:3000"
      # Scale TCP Server - DP-401 scales connect here
      - "${TCP_PORT:-8899}:8899"
    
    # ─────────────────────────────────────────────────────────────────────────────
    # Environment Variables
    # ─────────────────────────────────────────────────────────────────────────────
    environment:
      # Edge Identity (set these for your site)
      - EDGE_NAME=${EDGE_NAME:-}
      - SITE_ID=${SITE_ID:-}
      - REGISTRATION_TOKEN=${REGISTRATION_TOKEN:-}
      
      # Cloud Connection
      - CLOUD_API_URL=${CLOUD_API_URL:-https://api.carnitrack.com/api/v1/edge}
      
      # Servers
      - TCP_PORT=${TCP_PORT:-8899}
      - TCP_HOST=${TCP_HOST:-0.0.0.0}
      - HTTP_PORT=${HTTP_PORT:-3000}
      - HTTP_HOST=${HTTP_HOST:-0.0.0.0}
      
      # Database
      - DB_PATH=/app/data/carnitrack.db
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - NODE_ENV=${NODE_ENV:-production}
    
    # ─────────────────────────────────────────────────────────────────────────────
    # Volumes - Persist data across container restarts
    # ─────────────────────────────────────────────────────────────────────────────
    volumes:
      # SQLite database - CRITICAL: persist this!
      - carnitrack-data:/app/data
      # Logs
      - carnitrack-logs:/app/logs
      # Generated PLU files
      - carnitrack-generated:/app/generated
    
    # ─────────────────────────────────────────────────────────────────────────────
    # Network
    # ─────────────────────────────────────────────────────────────────────────────
    networks:
      - carnitrack-network
    
    # ─────────────────────────────────────────────────────────────────────────────
    # Health Check
    # ─────────────────────────────────────────────────────────────────────────────
    healthcheck:
      test: ["CMD", "bun", "--eval", "fetch('http://localhost:3000/health').then(r => process.exit(r.ok ? 0 : 1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # ─────────────────────────────────────────────────────────────────────────────
    # Logging
    # ─────────────────────────────────────────────────────────────────────────────
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ═══════════════════════════════════════════════════════════════════════════════
# Volumes
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  carnitrack-data:
    name: carnitrack-edge-data
  carnitrack-logs:
    name: carnitrack-edge-logs
  carnitrack-generated:
    name: carnitrack-edge-generated

# ═══════════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  carnitrack-network:
    name: carnitrack-network
    driver: bridge
